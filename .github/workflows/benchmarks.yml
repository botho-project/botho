name: Benchmarks

on:
  # Run on PRs to check for regressions
  pull_request:
    paths:
      - 'crypto/**'
      - 'botho/src/**'
      - 'transaction/**'
      - '**/benches/**'
      - '.github/workflows/benchmarks.yml'
  # Manual trigger for full benchmark runs
  workflow_dispatch:
    inputs:
      full_run:
        description: 'Run full benchmarks (not quick mode)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  compile-benchmarks:
    name: Compile Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-
            ${{ runner.os }}-cargo-

      - name: Compile benchmarks (all packages)
        run: cargo bench --no-run --workspace

  run-crypto-benchmarks:
    name: Crypto Benchmarks
    runs-on: ubuntu-latest
    needs: compile-benchmarks
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Run CLSAG benchmarks (quick)
        if: ${{ github.event_name == 'pull_request' || github.event.inputs.full_run != 'true' }}
        run: cargo bench -p bth-crypto-ring-signature -- --quick --noplot
        continue-on-error: true

      - name: Run LION benchmarks (quick)
        if: ${{ github.event_name == 'pull_request' || github.event.inputs.full_run != 'true' }}
        run: cargo bench -p bth-crypto-lion -- --quick --noplot
        continue-on-error: true

      - name: Run CLSAG benchmarks (full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_run == 'true' }}
        run: cargo bench -p bth-crypto-ring-signature -- --noplot

      - name: Run LION benchmarks (full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_run == 'true' }}
        run: cargo bench -p bth-crypto-lion -- --noplot

  run-node-benchmarks:
    name: Node Benchmarks
    runs-on: ubuntu-latest
    needs: compile-benchmarks
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Run block benchmarks (quick)
        if: ${{ github.event_name == 'pull_request' || github.event.inputs.full_run != 'true' }}
        run: cargo bench -p botho --bench block_benchmarks -- --quick --noplot
        continue-on-error: true

      - name: Run mempool benchmarks (quick)
        if: ${{ github.event_name == 'pull_request' || github.event.inputs.full_run != 'true' }}
        run: cargo bench -p botho --bench mempool_benchmarks -- --quick --noplot
        continue-on-error: true

      - name: Run traffic normalization benchmarks (quick)
        if: ${{ github.event_name == 'pull_request' || github.event.inputs.full_run != 'true' }}
        run: cargo bench -p botho --bench traffic_normalization -- --quick --noplot
        continue-on-error: true

      - name: Run block benchmarks (full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_run == 'true' }}
        run: cargo bench -p botho --bench block_benchmarks -- --noplot

      - name: Run mempool benchmarks (full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_run == 'true' }}
        run: cargo bench -p botho --bench mempool_benchmarks -- --noplot

      - name: Run traffic normalization benchmarks (full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_run == 'true' }}
        run: cargo bench -p botho --bench traffic_normalization -- --noplot

  run-transaction-benchmarks:
    name: Transaction Benchmarks
    runs-on: ubuntu-latest
    needs: compile-benchmarks
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Run transaction benchmarks (quick)
        if: ${{ github.event_name == 'pull_request' || github.event.inputs.full_run != 'true' }}
        run: cargo bench -p bth-transaction-core -- --quick --noplot
        continue-on-error: true

      - name: Run transaction benchmarks (full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_run == 'true' }}
        run: cargo bench -p bth-transaction-core -- --noplot

  summary:
    name: Benchmark Summary
    runs-on: ubuntu-latest
    needs: [compile-benchmarks, run-crypto-benchmarks, run-node-benchmarks, run-transaction-benchmarks]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Crypto (CLSAG/LION) | ${{ needs.run-crypto-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node (Block/Mempool/Traffic) | ${{ needs.run-node-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Transaction | ${{ needs.run-transaction-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Cryptography" >> $GITHUB_STEP_SUMMARY
          echo "- CLSAG sign: <10ms" >> $GITHUB_STEP_SUMMARY
          echo "- CLSAG verify: <5ms" >> $GITHUB_STEP_SUMMARY
          echo "- LION sign: <100ms" >> $GITHUB_STEP_SUMMARY
          echo "- LION verify: <50ms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Traffic Normalization (Phase 2)" >> $GITHUB_STEP_SUMMARY
          echo "- Standard: <200ms p99 latency, <50% bandwidth overhead" >> $GITHUB_STEP_SUMMARY
          echo "- Maximum: <1s p99 latency, <2x bandwidth overhead" >> $GITHUB_STEP_SUMMARY
          echo "- CPU overhead: <5% (standard), <10% (maximum)" >> $GITHUB_STEP_SUMMARY
          echo "- Memory overhead: <10MB (standard), <50MB (maximum)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: Benchmarks run in quick mode on PRs. Use workflow_dispatch with full_run=true for detailed results." >> $GITHUB_STEP_SUMMARY
