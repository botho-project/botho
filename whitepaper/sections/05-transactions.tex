% ============================================================================
% Section 5: Transaction Format
% ============================================================================

\section{Transaction Format}
\label{sec:transactions}

\subsection{Transaction Types}

\Botho supports two transaction types:

\begin{table}[h]
\centering
\caption{Transaction type comparison}
\label{tab:tx-types}
\begin{tabular}{@{}lccccl@{}}
\toprule
\textbf{Type} & \textbf{Inputs} & \textbf{Outputs} & \textbf{Signature} & \textbf{Size} & \textbf{Use Case} \\
\midrule
Minting & 0 & 1--16 & ML-DSA-65 & $\sim$2 KB & Block rewards \\
Private & 1--16 & 1--16 & CLSAG & $\sim$4 KB & All transfers \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Private Transaction Structure}

A private transaction transfers value while hiding sender, recipient,
and amount.

\subsubsection{Transaction Components}

\begin{lstlisting}[language=,caption={Private transaction structure}]
PrivateTransaction {
    prefix: TransactionPrefix,
    ring_signatures: Vec<CLSAGSignature>,
    bulletproofs: AggregatedRangeProof,
}

TransactionPrefix {
    version: u8,
    inputs: Vec<TxInput>,
    outputs: Vec<TxOutput>,
    fee: u64,
    extra: Vec<u8>,
}
\end{lstlisting}

\subsubsection{Input Structure}

Each input references a previously unspent output without revealing which:

\begin{lstlisting}[language=,caption={Transaction input structure}]
TxInput {
    ring: [TxOutRef; RING_SIZE],  // RING_SIZE = 20
    key_image: KeyImage,           // 32 bytes
    cluster_tag: ClusterTag,       // 32 bytes
}

TxOutRef {
    block_height: u64,
    tx_index: u16,
    output_index: u8,
}
\end{lstlisting}

The \texttt{ring} contains references to 20 possible source outputs.
The \texttt{key\_image} uniquely identifies the spent output (for
double-spend prevention) without revealing which ring member it
corresponds to.

\subsubsection{Output Structure}

Each output contains the encrypted amount and one-time keys:

\begin{lstlisting}[language=,caption={Transaction output structure}]
TxOutput {
    commitment: CompressedPoint,      // Pedersen commitment (32 bytes)
    one_time_key: CompressedPoint,    // One-time public key (32 bytes)
    encrypted_amount: [u8; 32],       // AES-encrypted amount
    ml_kem_ciphertext: [u8; 1088],    // ML-KEM ciphertext
    cluster_tag: ClusterTag,          // Derived from input tags
}
\end{lstlisting}

\subsection{Minting Transaction Structure}

Minting transactions create new coins as block rewards:

\begin{lstlisting}[language=,caption={Minting transaction structure}]
MintingTransaction {
    block_height: u64,
    nonce: u64,
    minter_public_key: MLDSAPublicKey,  // 1,952 bytes
    outputs: Vec<TxOutput>,
    signature: MLDSASignature,           // 3,309 bytes
}
\end{lstlisting}

Unlike private transactions:
\begin{itemize}
  \item No inputs (new coins created)
  \item Public amounts (for supply auditability)
  \item Known sender (minter identity is public)
  \item Recipients still hidden via stealth addresses
\end{itemize}

\subsection{Cluster Tags and Progressive Fees}
\label{sec:cluster-tags}

Cluster tags enable Sybil-resistant progressive fees by tracking coin
\textit{provenance} rather than current ownership. The key insight is that
splitting coins does not change where they came from.

\subsubsection{Tag Vector Representation}

Each UTXO carries a \textit{tag vector} representing the weighted distribution
of its ancestry across all clusters:

\begin{equation}
\vec{t} = \{(c_1, w_1), (c_2, w_2), \ldots, (c_k, w_k)\} \quad \text{where} \sum_i w_i = 1
\end{equation}

Here $c_i$ is a cluster identifier and $w_i$ is the fraction of the UTXO's
value attributable to that cluster.

\subsubsection{Cluster Creation at Minting}

Each minting transaction creates a new cluster. The minter's public key
hash serves as the cluster identifier:

\begin{equation}
c_{\text{new}} = \Hash(\text{minter\_pubkey} \| \text{block\_height})
\end{equation}

Minting outputs carry a tag vector with 100\% attribution to the new cluster:
$\vec{t}_{\text{mint}} = \{(c_{\text{new}}, 1.0)\}$.

\subsubsection{Tag Inheritance and Blending}

When spending multiple inputs, output tags are computed via value-weighted
blending:

\begin{equation}
\vec{t}_{\text{out}} = \frac{\sum_i v_i \cdot \vec{t}_i}{\sum_i v_i}
\end{equation}

where $v_i$ is the value of input $i$ and $\vec{t}_i$ is its tag vector.

\textbf{Example}: Combining a 70 BTH UTXO (100\% cluster A) with a 30 BTH
UTXO (100\% cluster B) produces output tags: $\{(A, 0.7), (B, 0.3)\}$.

\subsubsection{Age-Based Tag Decay}

To encourage circulation and prevent wash trading, tags decay over time.
However, decay only applies when UTXOs meet an age threshold:

\begin{equation}
\vec{t}'_i = \begin{cases}
0.95 \cdot \vec{t}_i & \text{if age}(\text{UTXO}_i) \geq T_{\min} \\
\vec{t}_i & \text{otherwise}
\end{cases}
\end{equation}

where $T_{\min} = 720$ blocks ($\approx$ 2 hours at 10s blocks).

\textbf{Wash Trading Resistance}: Since new outputs must wait before decay
applies, rapid self-transfers achieve no decay:

\begin{table}[h]
\centering
\caption{Tag decay limits}
\label{tab:decay-limits}
\begin{tabular}{@{}lcc@{}}
\toprule
\textbf{Attack} & \textbf{Transactions} & \textbf{Maximum Decay} \\
\midrule
Rapid wash (1 minute) & 100 & 0\% \\
Patient wash (1 day) & 1000 & 46\% \\
Patient wash (1 week) & 7000 & 97\% \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Cluster Factor Calculation}

The cluster factor is derived from the dominant cluster's total minted wealth:

\begin{equation}
\text{cluster\_factor} = 1 + 5 \cdot \sigma\left(\frac{W_{\max}}{\text{steepness}}\right)
\end{equation}

where $W_{\max}$ is the total BTH ever minted by the dominant cluster and
$\sigma(x) = x/(1+x)$ is a sigmoid function.

\begin{table}[h]
\centering
\caption{Progressive fee multipliers}
\label{tab:fee-multipliers}
\begin{tabular}{@{}lc@{}}
\toprule
\textbf{Cluster Wealth Percentile} & \textbf{Fee Multiplier} \\
\midrule
Bottom 50\% & 1.0$\times$ -- 1.5$\times$ \\
50th -- 90th & 1.5$\times$ -- 3.0$\times$ \\
Top 10\% & 3.0$\times$ -- 6.0$\times$ \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Ring Signature Tag Propagation}

Ring signatures hide which input is real among $n$ decoys. To prevent fee
evasion via low-factor decoy selection, tags propagate \textit{conservatively}:

\begin{enumerate}
  \item All ring members' tag vectors are publicly known
  \item Fee is calculated using the \textit{maximum} cluster factor among
    ring members
  \item Output tags propagate from the real input (verified via ZK proof
    but not revealed)
\end{enumerate}

This ensures attackers cannot reduce fees by choosing low-factor decoys.

\subsubsection{Sybil Resistance Analysis}

The cluster tag system resists common attacks:

\begin{itemize}
  \item \textbf{Splitting coins}: Does not reduce fees---child outputs
    inherit the parent's cluster attribution unchanged.
  \item \textbf{Creating multiple addresses}: All outputs from the same
    cluster share the same factor.
  \item \textbf{Wash trading}: Age-based gating limits decay to $\sim$12
    events per day maximum.
  \item \textbf{Mixing through exchanges}: Reduces cluster concentration
    over time, but requires actual economic activity (legitimate use case).
\end{itemize}

\begin{theorem}[Cluster Tag Sybil Resistance]
For any splitting strategy that divides $n$ BTH into $k$ UTXOs, the total
fees paid are at least as high as paying from a single UTXO.
\end{theorem}

\begin{proof}[Proof sketch]
Let UTXO $U$ have cluster factor $f$. Splitting $U$ into $U_1, \ldots, U_k$
produces outputs with identical tag vectors (value-weighted average of
single input). Each $U_i$ inherits factor $f$. Total fees:
$\sum_i \text{fee}(U_i) = \sum_i (b \cdot s_i \cdot f) = b \cdot f \cdot \sum_i s_i$,
which equals the fee for transacting the full amount.
\end{proof}

\subsection{Validation Rules}

A private transaction is valid if and only if:

\begin{enumerate}
  \item \textbf{Structure}: 1--16 inputs, 1--16 outputs, valid encoding

  \item \textbf{Key Image Uniqueness}: All key images are:
    \begin{itemize}
      \item Distinct within this transaction
      \item Not present in the key image database (no double-spend)
    \end{itemize}

  \item \textbf{Ring Validity}: For each input ring:
    \begin{itemize}
      \item All referenced outputs exist and are unspent
      \item Ring members are sorted (canonical ordering)
      \item Real output is among the ring members
    \end{itemize}

  \item \textbf{Signature Validity}: All CLSAG signatures verify

  \item \textbf{Value Conservation}:
    \begin{equation}
    \sum_i C_{\text{in}}^{(i)} = \sum_j C_{\text{out}}^{(j)} + \text{fee} \cdot H
    \end{equation}

  \item \textbf{Range Proofs}: Bulletproofs verify for all output
    commitments (amounts in $[0, 2^{64})$)

  \item \textbf{Fee}: $\text{fee} \geq \text{min\_fee}(\text{size}, \text{cluster\_factor})$

  \item \textbf{Size}: Total serialized size $\leq$ 100 KB
\end{enumerate}

\subsection{Transaction Size Analysis}

\begin{table}[h]
\centering
\caption{Private transaction size breakdown (1-in-2-out)}
\label{tab:tx-size}
\begin{tabular}{@{}lr@{}}
\toprule
\textbf{Component} & \textbf{Size (bytes)} \\
\midrule
Transaction header & 32 \\
Input (ring references, key image) & 680 \\
Output $\times$ 2 (commitment, key, ciphertext) & 2,304 \\
CLSAG signature & 704 \\
Bulletproof (2 outputs, aggregated) & 736 \\
Cluster tags & 96 \\
\midrule
\textbf{Total} & $\sim$4,552 \\
\bottomrule
\end{tabular}
\end{table}

For comparison, a post-quantum ring signature would add approximately
35 KB per input, making transactions 10$\times$ larger.

\subsection{Decoy Selection}

Ring members are selected to maximize anonymity:

\begin{enumerate}
  \item \textbf{Age distribution}: Decoys follow the empirical spend-age
    distribution (recent outputs are more likely to be real)

  \item \textbf{Cluster similarity}: At least 70\% cosine similarity
    between decoy and real cluster tags (prevents fingerprinting)

  \item \textbf{Output type matching}: Decoys match the real output's
    characteristics (amount range, if known)

  \item \textbf{Randomization}: Subject to above constraints, selection
    is randomized
\end{enumerate}

\subsection{Transaction Malleability}

\Botho transactions resist malleability:
\begin{itemize}
  \item \textbf{Signature covers full prefix}: Modifying any field
    invalidates signatures
  \item \textbf{Canonical encoding}: Only one valid serialization exists
  \item \textbf{Key image binding}: Key images are deterministic from
    private keys
\end{itemize}

The transaction hash (txid) is computed over the canonical serialization
of the complete transaction.
