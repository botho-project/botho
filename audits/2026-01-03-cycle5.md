# Internal Security Audit Report - Cycle 5

**Date**: 2026-01-03
**Auditor**: Internal (Claude Code assisted)
**Scope**: Full - Post Onion Gossip Phase 1
**Commit**: `633e552`

---

## Executive Summary

Fifth comprehensive internal audit following the Onion Gossip Phase 1 implementation. This audit validates the new privacy layer and verifies continued resolution of all Critical and High issues. The Onion Gossip implementation demonstrates **excellent security engineering** with proper cryptographic primitives, comprehensive rate limiting, and thorough adversarial testing. Test coverage increased significantly (+39%).

**Overall Status**: Healthy (No Critical or High issues)

| Severity | Cycle 4 | Cycle 5 | Change |
|----------|---------|---------|--------|
| Critical | 0 | 0 | - |
| High | 0 | 0 | - |
| Medium | 6 | 6 | - |
| Low | 5 | 5 | - |
| Info | 4 | 5 | +1 |

---

## Automated Security Checks

| Check | Cycle 4 | Cycle 5 | Change |
|-------|---------|---------|--------|
| `cargo audit` | 0 vulnerabilities | 0 vulnerabilities | - |
| Unmaintained warnings | 20 | 20 | - |
| `cargo test -p botho --lib` | 381 passed | 531 passed | +150 (+39%) |
| `cargo test -p bth-consensus-scp --lib` | 98 passed | 98 passed | - |
| Crypto crates unsafe enforcement | 9/9 (100%) | 9/9 (100%) | - |
| Clippy errors | 0 | 207 (`println!` lint) | New |
| Clippy warnings | 66 | 70 | +4 |

**Note**: The 207 clippy "errors" are `println!` usage violations from a stricter lint configuration. This is a code style issue, not a security concern. The CLI commands legitimately use `println!` for output.

---

## Major Changes Since Cycle 4

### Onion Gossip Phase 1 Implementation

**Location**: `botho/src/network/privacy/`

A comprehensive traffic analysis resistance system was added:

| Component | Lines | Purpose |
|-----------|-------|---------|
| `crypto.rs` | ~300 | ChaCha20-Poly1305 onion encryption |
| `handshake.rs` | ~400 | X25519 circuit key establishment |
| `selection.rs` | ~450 | Subnet-diverse hop selection |
| `rate_limit.rs` | ~280 | Per-peer token bucket limiting |
| `routing.rs` | ~400 | Dual-path message routing |
| `circuit.rs` | ~500 | Circuit pool management |
| `relay.rs` | ~350 | Relay message handling |
| `broadcaster.rs` | ~250 | Private transaction broadcast |
| `metrics.rs` | ~200 | Privacy metrics collection |
| **Total** | ~3,130 | - |

### Privacy Integration Tests

**Location**: `botho/tests/privacy_integration.rs` (1,156 lines)

Comprehensive adversarial testing added:

- `test_adversarial_deanonymization_10_percent`: Verifies <15% attribution rate
- `test_sybil_resistance_subnet_diversity`: Limits adversary to 1 hop/circuit
- `test_correlation_resistance`: Ensures >80% circuit diversity
- `test_exit_node_origin_hiding`: Verifies exit distribution
- `test_first_hop_timing_resistance`: Tests timing attack resistance
- `test_malformed_message_handling`: Validates error handling

### Phase 1 Security Audit

**Location**: `docs/security/onion-gossip-phase1-audit.md`

Internal security audit of Onion Gossip found:
- **Critical**: 0
- **High**: 0
- **Medium**: 0
- **Low**: 3 (fuzz targets, per-peer limiting, nonce tracking)
- **Status**: Approved for mainnet deployment

---

## Areas Reviewed

- [x] 1. Cryptographic Implementations - STRONG
- [x] 2. Key Derivation & Management - STRONG
- [x] 3. Consensus Protocol (SCP) - CLEAN
- [x] 4. Transaction Validation - STRONG
- [x] 5. Privacy Analysis (Ring Signatures + Onion Gossip) - EXCELLENT
- [x] 6. Network Security - EXCELLENT
- [x] 7. Wallet Security - GOOD (unchanged from Cycle 4)
- [x] 8. Unsafe Rust Code - ENFORCED
- [x] 9. Dependencies - ACCEPTABLE (GTK3 unmaintained)

---

## Critical Findings

*No critical findings.*

---

## High Findings

*No high findings.*

---

## Medium Findings (Unchanged from Cycle 4)

### [MEDIUM] Floating-Point in Fee Calculation

**Location**: `transaction/core/src/validation/validate.rs:604-610`
**Status**: Open

```rust
let x = wealth as f64 / config.steepness as f64;
let sigmoid = x / (1.0 + x);
```

**Impact**: Minor precision discrepancies possible, mitigated by minimum fee requirement.

---

### [MEDIUM] Sync Response Bandwidth

**Location**: `botho/src/network/sync.rs`
**Status**: Open

- `MAX_RESPONSE_SIZE = 10 MB`
- `MAX_REQUESTS_PER_MINUTE = 60`
- Theoretical: 600 MB/min from single peer

---

### [MEDIUM] Cluster Wealth Tracking Disabled

**Location**: `botho/src/mempool.rs:408,478`
**Status**: Open

`cluster_wealth` hardcoded to 0, disabling progressive fee system.

---

### [MEDIUM] Block Timing Inconsistency

**Status**: Open

60s vs 5-40s dynamic timing in different modules.

---

### [MEDIUM] Unit Naming Confusion

**Status**: Open

326 occurrences of "picocredits" vs "nanoBTH" across 62 files.

---

### [MEDIUM] Unsound glib v0.18.5

**Location**: Tauri/GTK3 ecosystem
**Status**: Open (upstream issue)

Iterator UB in GTK bindings. Requires GTK4 migration.

---

## Low Findings (Unchanged from Cycle 4)

### [LOW] Deprecated derive_pq_keys() Still Present

**Location**: `crypto/pq/src/derive.rs:114-115`
**Status**: Open

Deprecated function bypasses BIP39 key stretching. Marked deprecated but kept for test compatibility.

---

### [LOW] Version Warnings Not Enforced

**Location**: `botho/src/network/discovery.rs`
**Status**: Open

Protocol version mismatches generate warnings but don't disconnect.

---

### [LOW] Rate Limiter State Unencrypted

**Location**: `botho-wallet/src/storage.rs`
**Status**: Open

Rate limiter saved as plaintext JSON. Acceptable given encrypted wallet.

---

### [LOW] Plaintext Mnemonic Export

**Location**: `botho-wallet/src/commands/export.rs`
**Status**: Open

---

### [LOW] 20 Unmaintained Dependencies

**Status**: Open (Tauri/GTK3 ecosystem)

---

## Info Findings

### [INFO] New - Clippy `println!` Lint Enforcement

**Status**: Observation

207 `println!` usages now flagged as errors by stricter clippy config. These are legitimate CLI output statements, not security issues.

**Recommendation**: Either allow `println!` in CLI command modules or migrate to structured logging.

---

### [INFO] Large PQ Key Sizes

ML-KEM-768: 1184 bytes, ML-DSA-65: 1952 bytes public key, 3309 bytes signatures.

---

### [INFO] Test RNG Separation

Tests use `Hc128Rng` for reproducibility. No leakage to production.

---

### [INFO] Reputation System Integration

ReputationManager integration with sync rate limiting not fully visible.

---

### [INFO] PEX Rate Limit

12 messages/hour per peer for network bootstrapping.

---

## Onion Gossip Security Assessment

### Cryptographic Strengths

1. **Key Exchange**: X25519 ephemeral DH with fresh keys per circuit
2. **Encryption**: ChaCha20-Poly1305 AEAD with proper nonce handling
3. **Key Derivation**: HKDF-SHA256 with domain separation per circuit
4. **Zeroization**: `Zeroize` trait on `SymmetricKey`
5. **Forward Secrecy**: Ephemeral keys + 10-minute circuit rotation

### Protocol Strengths

1. **Subnet Diversity**: /16 subnet diversity enforced (no 2 hops same subnet)
2. **Rate Limiting**: Per-peer token bucket (10 creates/min, 100 msgs/sec, 1MB/s)
3. **Weighted Selection**: Score-based selection prevents gaming
4. **Dual-Path Routing**: Transactions->private, SCP->fast, configurable fallback

### Adversarial Testing

| Test | Assertion |
|------|-----------|
| 10% adversary attribution | <15% success rate |
| Sybil resistance | Max 1 adversary hop per circuit |
| Circuit diversity | >80% unique circuits |
| Hop concentration | <15% max concentration |
| Exit distribution | Exits shared between origins |

**Overall**: Onion Gossip implementation is **production-ready**.

---

## Security Strengths Verified

1. **Zero critical/high issues** - 2 consecutive clean audits
2. **Cryptographic implementations**: No unsafe code, 9/9 crypto crates enforced
3. **Ring signatures**: CLSAG with domain separation, value balance verification
4. **Post-quantum**: Hybrid ML-KEM-768 + ML-DSA-65 approach
5. **Network security**: Multi-layer rate limiting, size validation, per-IP limits
6. **Wallet security**: Argon2id, ChaCha20-Poly1305, mlock memory protection
7. **SCP consensus**: clippy denies for unwrap/expect/panic
8. **Onion Gossip**: X25519, ChaCha20-Poly1305, subnet diversity, comprehensive testing
9. **Test coverage**: 531 botho tests (+39%), 98 SCP tests, 1,156 lines privacy tests

---

## Verification

| Check | Cycle 4 | Cycle 5 |
|-------|---------|---------|
| `cargo build` | PASS | PASS |
| `cargo test -p botho` | 381 passed | 531 passed |
| `cargo test -p bth-consensus-scp` | 98 passed | 98 passed |
| `cargo audit` | 0 critical | 0 critical |
| Crypto unsafe enforcement | 9/9 (100%) | 9/9 (100%) |

---

## Recommendations by Priority

### Short-term (30 days)

1. Address clippy `println!` lint (207 errors) - either allow in CLI modules or use structured output
2. Add fuzz target for `unwrap_onion()` (per Onion Gossip audit L-001)
3. Consider per-peer rate limiting in addition to per-circuit (L-002)

### Medium-term

4. Implement fixed-point arithmetic for fee calculation
5. Enable cluster wealth tracking for progressive fees
6. Add nonce replay tracking at relay level (L-003)

### Long-term

7. Migrate desktop from GTK3 to GTK4 (fixes glib unsound)
8. KEM-based handshake for post-quantum onion circuits (Phase 3)
9. Cover traffic generation (Phase 2)

---

## Comparison to Previous Audits

| Metric | Cycle 3 | Cycle 4 | Cycle 5 |
|--------|---------|---------|---------|
| Critical | 0 | 0 | 0 |
| High | 0 | 0 | 0 |
| Medium | 10 | 6 | 6 |
| Botho tests | 381 | 381 | 531 |
| New code (LOC) | - | ~500 | ~4,300 |

**Trend**: Security posture remains strong. All critical and high issues remain resolved through 3 consecutive audits. Significant new privacy infrastructure added with excellent security properties. Test coverage increased 39%.

---

## Path to External Audit

| Requirement | Status |
|-------------|--------|
| 3+ consecutive audits no Critical/High | **3/3** (Cycle 3-5) |
| All Medium findings resolved | 6 remaining |
| Test coverage >80% crypto | Needs measurement |
| Fuzz testing operational | Partial |
| Documentation complete | Whitepaper added |

**Recommendation**: With 3 consecutive clean audits (no Critical/High), the codebase is approaching external audit readiness. Resolve Medium issues and add fuzz testing infrastructure before commissioning.

---

## Time Spent

| Activity | Hours |
|----------|-------|
| Automated analysis | ~0.25 |
| Onion Gossip review | ~0.75 |
| Previous findings verification | ~0.25 |
| Privacy integration tests review | ~0.5 |
| Report compilation | ~0.25 |
| **Total** | **~2** |
