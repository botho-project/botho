# Internal Security Audit Report

**Date**: 2025-12-30
**Auditor**: Internal (Claude Code assisted)
**Scope**: Full
**Commit**: `c31a8f9` (start), `4172a68` (end)

---

## Executive Summary

First comprehensive internal audit of the Botho codebase. Reviewed all major security-critical areas including cryptographic implementations, consensus protocol, transaction validation, privacy mechanisms, and network security.

**One critical issue was found and fixed**: SCP ballot ordering validation was missing, which could have allowed consensus manipulation. Several build errors were also discovered and fixed, indicating code had drifted from API changes.

**Overall Status**: Issues Found (1 Critical fixed, 1 High fixed, 2 Medium open)

| Severity | Count |
|----------|-------|
| Critical | 1 (fixed) |
| High | 1 (fixed) |
| Medium | 2 (open) |
| Low | 2 (open) |
| Info | 0 |

---

## Sections Reviewed

- [x] 1. Cryptographic Implementations
  - [x] 1.1 MLSAG Ring Signatures - Clean
  - [x] 1.2 CLSAG Ring Signatures - Clean
  - [x] 1.3 LION Post-Quantum Signatures - Clean (updated params documented)
  - [x] 1.4 Pedersen Commitments - Clean
  - [x] 1.5 Bulletproofs Range Proofs - Not deeply reviewed
- [x] 2. Key Derivation & Management - Clean (SLIP-10, HKDF, zeroization)
- [x] 3. Consensus Protocol (SCP) - **CRITICAL FIXED**
- [x] 4. Transaction Validation - Medium issues noted
- [x] 5. Privacy Analysis (Decoy Selection) - Clean (OSPEAD, ring 20)
- [x] 6. Network Security - Clean (rate limiting, DoS protection)
- [x] 7. Wallet Security - **HIGH issue found**
- [x] 8. Unsafe Rust Code - Clean (all justified)
- [x] 9. Dependencies - 2 of 3 vulnerabilities fixed
- [x] 10. Known Issues & TODOs - Reviewed
- [x] 10.5 Ring Structure & Minting Dynamics - Documented

---

## Findings

### [CRITICAL] SCP Ballot Ordering Not Validated (FIXED)

**Location**: `consensus/scp/src/slot.rs:382`, `consensus/scp/src/msg.rs`
**Status**: Fixed

**Description**:
SCP messages containing ballots with unsorted values were accepted. The comment at slot.rs:382 said "TODO: Reject messages with incorrectly ordered values" but this was never implemented.

**Impact**:
Consensus safety could be compromised. Nodes processing ballot values in different orders could reach different conclusions, potentially allowing conflicting values to be externalized.

**Recommendation**:
Add validation in `Msg::validate()` to reject ballots with unsorted values.

**Resolution**:
- Added `Ballot::is_values_sorted()` method in `ballot.rs`
- Added `validate_ballot_ordering` closure in `msg.rs:validate()`
- Applied to PreparePayload, CommitPayload, ExternalizePayload
- Fixed 8 test cases that used unsorted ballot values
- All 98 SCP tests pass

---

### [HIGH] Wallet Mnemonic Not Zeroized (FIXED)

**Location**: `botho/src/wallet.rs:38`
**Status**: Fixed

**Description**:
The `Wallet` struct stores `mnemonic_phrase: String` but does not implement `Zeroize` or `Drop` to clear this sensitive data from memory.

**Impact**:
Mnemonic phrases could persist in memory after wallet is dropped, potentially exposing them to memory dumps or side-channel attacks.

**Recommendation**:
Add `#[derive(Zeroize, ZeroizeOnDrop)]` to the `Wallet` struct, or implement a custom `Drop` that zeroizes the mnemonic.

**Resolution**:
Fixed - Changed `mnemonic_phrase: String` to `mnemonic_phrase: Zeroizing<String>`. The `Zeroizing` wrapper from the `zeroize` crate automatically overwrites memory with zeros when dropped.

---

### [MEDIUM] Cluster Wealth Tracking Disabled

**Location**: `botho/src/mempool.rs:93`, `botho/src/commands/send.rs:83`
**Status**: Open

**Description**:
`cluster_wealth` is hardcoded to `0u64` everywhere, disabling the progressive fee system designed to charge higher fees to wealthier clusters.

**Impact**:
Progressive fees don't work as designed. Privacy implications if wealthy clusters aren't incentivized to use larger ring sizes.

**Recommendation**:
Implement cluster wealth tracking from UTXO set analysis.

**Resolution**:
Open - requires implementation.

---

### [MEDIUM] RPC PQ Transaction Validation Deferred

**Location**: `botho/src/rpc/mod.rs:671`
**Status**: Acknowledged

**Description**:
Post-quantum transaction submission via RPC defers full validation until block inclusion. Comment notes this is intentional but lists missing checks.

**Impact**:
Invalid PQ transactions could enter mempool, wasting resources. However, they will be rejected at block validation.

**Recommendation**:
Document this as intentional design decision. Consider adding optional early validation.

**Resolution**:
Acknowledged as design decision - validation occurs at block inclusion.

---

### [LOW] Empty Cluster Tags Treated as Maximally Similar

**Location**: `botho/src/decoy_selection.rs:136-138`
**Status**: Open

**Description**:
When comparing cluster tags, empty tags return similarity of 1.0 (maximally similar to everything).

**Impact**:
Early network outputs with no cluster tags could be fingerprinted as likely decoys since they match everything.

**Recommendation**:
Consider treating empty tags as having neutral (0.5) similarity, or document the privacy implications.

**Resolution**:
Open - low priority, network bootstrapping consideration.

---

### [LOW] Remaining Dependency Vulnerability

**Location**: `Cargo.lock` (ring 0.16.20)
**Status**: Acknowledged

**Description**:
RUSTSEC-2025-0009: AES-GCM panic possible in ring 0.16.20 under specific conditions (64GB+ encryption or QUIC).

**Impact**:
DoS only, not exploitable for fund theft. Requires overflow-checks enabled and specific usage patterns not present in Botho.

**Recommendation**:
Monitor for upstream updates to ethers/sentry that use newer ring versions.

**Resolution**:
Acknowledged as low-impact transitive dependency.

---

## Fixes Applied During Audit

| Issue | Severity | File | Fix |
|-------|----------|------|-----|
| SCP ballot ordering | CRITICAL | `ballot.rs`, `msg.rs`, `slot.rs` | Added validation |
| Wallet mnemonic not zeroized | HIGH | `wallet.rs` | Used `Zeroizing<String>` wrapper |
| Stale Transaction::new_private | Build | `wallet.rs` | → new_clsag |
| Stale TxInputs variants | Build | `mempool.rs` | Removed Simple/Ring/LegacyRing |
| Stale tx.is_private() | Build | `rpc/mod.rs` | → privacy_tier() |
| Stale fee_rate_bps | Build | `send.rs` | Removed references |
| Missing ADJUSTMENT_WINDOW | Build | `block.rs` | Added constant |
| crossbeam-channel vuln | Dep | Cargo.lock | Updated to 0.5.15 |
| tracing-subscriber vuln | Dep | Cargo.lock | Updated to 0.3.22 |

---

## Verification

| Check | Result |
|-------|--------|
| `cargo build` | PASS |
| `cargo test -p botho` | 229 passed |
| `cargo test -p bth-consensus-scp` | 98 passed |
| `cargo clippy` | Warnings only (style) |
| `cargo audit` | 1 low-severity remaining |

---

## Recommendations for Next Audit

1. ~~**Wallet zeroization** - High priority fix before next audit~~ ✓ Fixed
2. **Bulletproofs deep review** - Not covered in depth this audit
3. **Fuzz testing setup** - Need infrastructure for crypto fuzzing
4. **Cluster wealth implementation** - Design review needed
5. **Test coverage metrics** - Measure crypto code coverage

---

## Security Strengths Noted

1. **Cryptographic crates deny unsafe**: `core`, `account-keys` use `#![deny(unsafe_code)]`
2. **Network DoS protection**: Message size limits, per-peer rate limiting, reputation banning
3. **Key zeroization**: `AccountKey`, `QuantumSafeAccountKey` properly implement `Zeroize`
4. **Ring sizes**: CLSAG ring 20 (larger than Monero's 16), LION ring 11
5. **Decoy selection**: OSPEAD gamma distribution following Monero research
6. **SCP consensus**: Well-tested (98 tests), now with ballot ordering validation

---

## Time Spent

| Activity | Hours |
|----------|-------|
| Code review | ~3 |
| Testing | ~0.5 |
| Documentation | ~1 |
| **Total** | **~4.5** |
