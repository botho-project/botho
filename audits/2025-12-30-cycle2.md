# Internal Security Audit Report - Cycle 2

**Date**: 2025-12-30
**Auditor**: Internal (Claude Code assisted)
**Scope**: Full
**Commit**: `fdbddb7`

---

## Executive Summary

Second comprehensive internal audit following the established AUDIT.md checklist. All sections reviewed systematically. This audit identified significant issues in wallet security and dependency management that require attention before production deployment.

**Overall Status**: Issues Found (3 Critical, 7 High, 15+ Medium)

| Severity | Count |
|----------|-------|
| Critical | 3 |
| High | 7 |
| Medium | 15+ |
| Low | 10+ |
| Info | 5 |

---

## Sections Reviewed

- [x] 1. Cryptographic Implementations
  - [x] 1.1 MLSAG Ring Signatures - Clean (1 LOW)
  - [x] 1.2 CLSAG Ring Signatures - Clean
  - [x] 1.3 LION Post-Quantum Signatures - 2 MEDIUM
  - [x] 1.4 Pedersen Commitments - Clean
  - [x] 1.5 Bulletproofs Range Proofs - Not deeply reviewed
- [x] 2. Key Derivation & Management - 3 MEDIUM issues
- [x] 3. Consensus Protocol (SCP) - 2 HIGH, 2 MEDIUM
- [x] 4. Transaction Validation - 1 HIGH, 1 MEDIUM
- [x] 5. Privacy Analysis (Decoy Selection) - 1 HIGH, 1 MEDIUM
- [x] 6. Network Security - 1 HIGH, 3 MEDIUM
- [x] 7. Wallet Security - **3 CRITICAL, 3 HIGH, 4 MEDIUM**
- [x] 8. Unsafe Rust Code - 1 HIGH, 1 MEDIUM
- [x] 9. Dependencies - **1 CRITICAL (ring), 2 unsound, 22 unmaintained**
- [x] 10.5 Ring Structure & Minting - 3 MEDIUM concerns

---

## Critical Findings

### [CRITICAL] Mnemonic Not Zeroized in botho-wallet

**Location**: `botho-wallet/src/keys.rs:22-29`
**Status**: Open

**Description**:
The `WalletKeys` struct stores `mnemonic_phrase: String` as plain String without zeroization. The struct is also `Clone`, allowing unlimited copies.

```rust
#[derive(Clone)]
pub struct WalletKeys {
    mnemonic_phrase: String,  // Not zeroized!
    account_key: AccountKey,
}
```

**Impact**:
Mnemonic phrases persist in memory indefinitely. Memory dumps, swap files, or side-channel attacks could recover the recovery seed.

**Recommendation**:
Replace with `Zeroizing<String>` and remove or restrict `Clone` derive.

---

### [CRITICAL] Mnemonic Exposed to JavaScript Frontend

**Location**: `web/packages/desktop/src-tauri/src/wallet.rs:446,536`
**Status**: Open

**Description**:
The `LoadWalletFileResult` Tauri command returns decrypted mnemonic as `Option<String>` to JavaScript frontend. All wallet operations receive mnemonic from JS.

**Impact**:
- Mnemonic crosses Rust/JS boundary multiple times
- JavaScript strings cannot be reliably zeroized
- Vulnerable to XSS, malicious extensions, or developer tools

**Recommendation**:
Redesign to keep mnemonics exclusively in Rust memory. Use session-based architecture where JS provides password once.

---

### [CRITICAL] ring v0.16.20 Vulnerability (CVE-2025-4432)

**Location**: `Cargo.lock` (via reqwest, ethers, jsonwebtoken)
**Status**: Open

**Description**:
RUSTSEC-2025-0009: AES functions in ring 0.16.20 may panic when overflow checking is enabled, causing DoS.

**Impact**:
Affects bridge service, wallet HTTP calls, exchange scanner. DoS only, not exploitable for fund theft.

**Recommendation**:
Update reqwest to 0.12.x and ethers to version using ring 0.17.x. Project already has ring 0.17.14 available.

---

## High Findings

### [HIGH] Panic/Unwrap in SCP Consensus Paths

**Location**: `consensus/scp/src/slot.rs`, `msg.rs`, `node.rs`
**Status**: Open

**Description**:
Multiple `.unwrap()` and `panic!()` calls in consensus-critical code paths (7+ instances found).

**Impact**:
Malformed messages could crash nodes, disrupting consensus.

**Recommendation**:
Replace with proper error handling and graceful degradation.

---

### [HIGH] Missing Duplicate Node Detection in QuorumSet

**Location**: `consensus/scp/src/quorum_set.rs`
**Status**: Open

**Description**:
`QuorumSet::is_valid()` does not check for duplicate node IDs in validators or inner sets.

**Impact**:
Malicious quorum set configurations could manipulate voting weight.

**Recommendation**:
Add duplicate detection during quorum set validation.

---

### [HIGH] PQ Transaction RPC Validation Gap

**Location**: `botho/src/rpc/mod.rs:671-678`
**Status**: Acknowledged

**Description**:
Post-quantum transaction submission defers full validation until block inclusion. Missing checks documented in TODO.

**Impact**:
Invalid PQ transactions may enter mempool, wasting resources.

**Recommendation**:
Acknowledged as design decision; consider optional early validation.

---

### [HIGH] No Rate Limiting on Gossipsub Messages

**Location**: `botho/src/network/`
**Status**: Open

**Description**:
While RPC has rate limiting, gossipsub message handling lacks per-peer rate limits.

**Impact**:
Nodes could be flooded with gossip messages, causing resource exhaustion.

**Recommendation**:
Implement per-peer rate limiting on gossipsub topics.

---

### [HIGH] No Rate Limiting on Wallet Decryption

**Location**: `botho-wallet/src/storage.rs:90-125`
**Status**: Open

**Description**:
The `decrypt()` method has no rate limiting or anti-brute-force protection.

**Impact**:
Attacker with encrypted wallet file can attempt unlimited password guesses.

**Recommendation**:
Add exponential backoff and attempt counting.

---

### [HIGH] Test Mnemonics Could Be Used in Production

**Location**: Multiple test files
**Status**: Open

**Description**:
Well-known test mnemonics ("abandon abandon...") present throughout codebase without production detection.

**Impact**:
Developers might accidentally use test mnemonics with real funds.

**Recommendation**:
Add runtime checks rejecting known test mnemonics in production.

---

### [HIGH] LRU Cache Unsafe Iterator Pattern

**Location**: `common/src/lru.rs:281`
**Status**: Open

**Description**:
```rust
let entry = unsafe {
    &mut *(&mut self.cache.entries[entry_index] as *mut Option<(Arc<K>, V)>)
};
```
Creates multiple mutable references, violating Rust aliasing guarantees.

**Impact**:
Could cause undefined behavior if iteration invariants are broken.

**Recommendation**:
Replace with safe alternative (Cell/RefCell) or use established `lru` crate.

---

## Medium Findings

### [MEDIUM] LION Rejection Sampling Margin Undocumented
**Location**: `crypto/lion/src/params.rs`
No cryptographic justification for REJECTION_SAMPLING_MARGIN = 100.

### [MEDIUM] Empty HKDF Info Parameter
**Location**: `core/src/slip10/mod.rs`
HKDF uses empty info parameter, losing domain separation opportunity.

### [MEDIUM] Mnemonic Parsing Panics
**Location**: `botho-wallet/src/keys.rs`
Invalid mnemonic input causes panic instead of error.

### [MEDIUM] Unimplemented Ballot Range Union
**Location**: `consensus/scp/src/slot.rs:1755`
`find_blocking_set_for_range` contains TODO for ballot range logic.

### [MEDIUM] Cluster Wealth Tracking Disabled
**Location**: `botho/src/mempool.rs:93`
`cluster_wealth` hardcoded to 0, disabling progressive fees.

### [MEDIUM] Insufficient Password Complexity
**Location**: `botho-wallet/src/commands/init.rs:154`
Only checks 8 character minimum, no entropy validation.

### [MEDIUM] Plaintext Mnemonic Export
**Location**: `botho-wallet/src/commands/export.rs:44-56`
Exports mnemonic as plaintext file.

### [MEDIUM] Windows FFI Lacks Safety Comments
**Location**: `botho-wallet/src/storage.rs:335-408`
7 unsafe blocks without `// SAFETY:` documentation.

### [MEDIUM] Unsound anstream v0.6.7
**Location**: `Cargo.lock`
UTF-8 handling issue in CLI argument parsing.

### [MEDIUM] Unsound glib v0.18.5
**Location**: `Cargo.lock` (desktop only)
Iterator UB in GTK bindings.

### [MEDIUM] Block Timing Inconsistency
**Location**: `botho/src/monetary.rs` vs `botho/src/block.rs`
Two different block timing systems (60s vs 5-40s dynamic).

### [MEDIUM] Unit Naming Confusion
**Location**: Various
Code uses both "picocredits" and "nanoBTH" inconsistently.

### [MEDIUM] Missing Dust Threshold
**Location**: Transaction validation
No minimum output amount defined, risking unspendable UTXOs.

### [MEDIUM] Pending Requests No Cleanup
**Location**: `botho/src/network/`
Pending network requests lack timeout cleanup mechanism.

### [MEDIUM] 13 Crypto Crates Lack #![deny(unsafe_code)]
**Location**: `crypto/*/src/lib.rs`
Only 3 of 16 crypto crates enforce no-unsafe policy.

---

## Low Findings

- MLSAG TODO for better error type (`mlsag_sign.rs:229`)
- Empty cluster tags return 1.0 similarity (`decoy_selection.rs:136`)
- Windows ACL failures silently logged
- rpassword not version-pinned
- No memory locking (mlock) for keys
- 22 unmaintained dependencies (mostly GTK3 ecosystem)
- 3 yanked dependency versions

---

## Verification

| Check | Result |
|-------|--------|
| `cargo build` | PASS |
| `cargo test -p botho` | 229 passed |
| `cargo test -p bth-consensus-scp` | 98 passed |
| `cargo clippy` | Warnings only |
| `cargo audit` | 1 critical, 27 warnings |

---

## Recommendations by Priority

### Immediate (Before Production)

1. **Fix wallet mnemonic zeroization** (CRITICAL)
2. **Redesign Tauri wallet architecture** (CRITICAL)
3. **Update ring via reqwest/ethers** (CRITICAL)
4. **Add test mnemonic detection** (HIGH)
5. **Fix LRU cache unsafe code** (HIGH)
6. **Add SCP panic handling** (HIGH)

### Short-term (30 days)

7. Add wallet decryption rate limiting
8. Add gossipsub rate limiting
9. Create deny.toml for dependency policy
10. Add `#![deny(unsafe_code)]` to all crypto crates
11. Implement cluster wealth tracking
12. Add dust threshold

### Long-term

13. Migrate desktop app from GTK3 to GTK4
14. Deep review of Bulletproofs
15. Fuzz testing infrastructure
16. Hardware wallet support

---

## Comparison to Previous Audit (Cycle 1)

| Metric | Cycle 1 | Cycle 2 |
|--------|---------|---------|
| Critical | 1 (fixed) | 3 (new) |
| High | 1 | 7 |
| Medium | 2 | 15+ |
| Sections Reviewed | Partial | Full |

**New Issues Found**: Wallet security architecture, dependency vulnerabilities, unsafe code patterns.

**Improvements Needed**: The expanded scope revealed significant issues in wallet and desktop components that were not deeply reviewed in Cycle 1.

---

## Security Strengths Noted

1. Core crypto crates (`account-keys`, `core`) use `#![deny(unsafe_code)]`
2. `AccountKey` properly implements Zeroize
3. Strong encryption (ChaCha20-Poly1305, Argon2id) for wallet files
4. Ring sizes exceed Monero (CLSAG 20 vs 16)
5. OSPEAD decoy selection following research
6. Well-tested SCP (98 tests)
7. Overflow checks disabled in release (mitigates ring DoS)

---

## Time Spent

| Activity | Hours |
|----------|-------|
| Automated analysis | ~0.5 |
| Section 1-6 review | ~2 |
| Section 7-10.5 deep dive | ~2 |
| Report compilation | ~0.5 |
| **Total** | **~5** |
